version: "3.9"

services:
  vhs:
    build:
      context: .
      dockerfile: Dockerfile
    image: ghcr.io/successbyfailure/vhs:latest
    container_name: vhs
    env_file:
      - .env
    environment:
      CACHE_DIR: ${CACHE_DIR:-/app/data/cache}
      USAGE_LOG_PATH: ${USAGE_LOG_PATH:-/app/data/usage_log.jsonl}
      YTDLP_COOKIES_FILE: ${YTDLP_COOKIES_FILE:-/config/cookies.txt}
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
      - "com.centurylinklabs.watchtower.scope=vhs"
    ports:
      - "8601:8601"
    volumes:
      - ./config:/config
      - ./data:/app/data
    logging:
      driver: "json-file"
      options:
        max-size: "2m"
    restart: unless-stopped

  env_sync:
    image: ghcr.io/successbyfailure/vhs:latest
    command: >-
      python /app/scripts/update_env_from_example.py
    volumes:
      - ./.env:/app/.env
    logging:
      driver: "json-file"
      options:
        max-size: "2m"
    depends_on:
      - vhs

  watchtower:
    image: containrrr/watchtower:latest
    command: >-
      --cleanup --interval 300 --scope vhs --label-enable
    environment:
      DOCKER_API_VERSION: "1.44"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    logging:
      driver: "json-file"
      options:
        max-size: "2m"
    restart: unless-stopped
